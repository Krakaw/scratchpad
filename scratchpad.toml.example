# Scratchpad Configuration
# See https://github.com/Krakaw/scratchpad for documentation
# Run 'scratchpad setup' for interactive configuration

[server]
host = "0.0.0.0"
port = 3456
releases_dir = "./releases"

[docker]
socket = "/var/run/docker.sock"  # macOS with OrbStack: ~/.orbstack/run/docker.sock
network = "scratchpad-network"
label_prefix = "scratchpad"

[nginx]
enabled = true
config_path = "./nginx/scratches.conf"
domain = "scratch.local"
routing = "subdomain"  # or "path"
dynamic = true         # wildcard routing, no reload needed per scratch
ingress_service = "api"  # which service handles incoming requests
# container = "scratchpad-nginx"  # auto-set if nginx is a shared service

# GitHub configuration (optional, for webhooks)
# [github]
# token = "${GITHUB_TOKEN}"
# api_repo = "owner/api-repo"
# web_repo = "owner/web-repo"

# =============================================================================
# SHARED SERVICES - One instance, all scratches connect to it
# =============================================================================

[services.postgres]
image = "postgres:18"
shared = true
port = 5432
internal_port = 5432
auto_create_db = true  # creates scratch_<name> database per scratch
env = { POSTGRES_PASSWORD = "postgres", POSTGRES_USER = "postgres" }
healthcheck = "pg_isready -U postgres"

[services.redis]
image = "redis:8-alpine"
shared = true
port = 6379
healthcheck = "redis-cli ping"

[services.nginx]
image = "nginx:alpine"
shared = true
port = 80
internal_port = 80

# =============================================================================
# PER-SCRATCH SERVICES - Each scratch gets its own instance
# =============================================================================

# Example: Node.js API service
# [services.api]
# image = "myorg/api:latest"
# shared = false
# internal_port = 3000
# healthcheck = "curl -f http://localhost:3000/health"
# [services.api.env]
# NODE_ENV = "development"
# # DATABASE_URL and REDIS_URL are auto-injected

# Example: Background worker
# [services.worker]
# image = "myorg/worker:latest"
# shared = false
# [services.worker.env]
# NODE_ENV = "development"

# =============================================================================
# SCRATCH DEFAULTS & PROFILES
# =============================================================================

[scratch.defaults]
template = "default"
services = ["postgres", "redis", "nginx"]  # add your per-scratch services here

# Minimal profile - just database
[scratch.profiles.minimal]
services = ["postgres"]

# Full profile - all services
[scratch.profiles.full]
services = ["postgres", "redis", "nginx"]
